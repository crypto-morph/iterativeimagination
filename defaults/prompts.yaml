# LLM Prompts for Iterative Imagination
# Edit these prompts to adjust how the AI analyzes and evaluates images
# Use {placeholders} for dynamic content that will be filled in by the code

ask_question: |
  Answer this question about the image: {question}
  
  Question type: {type_info}{enum_info}{min_max_info}
  
  Provide your answer in JSON format matching the question type:
  {{
      "answer": <your_answer_here>
  }}
  
  For boolean questions, use true/false.
  For number/integer questions, provide a numeric value.
  For string questions, provide a text description.
  For array questions, provide a JSON array.

ask_multiple_questions: |
  Answer ALL of the following questions about the image. Answer each question carefully based on the image content.
  
  {questions_list}
  
  {original_image_context}
  
  Provide your answers in JSON format with one field per question:
  {{
      "<field1>": <answer1>,
      "<field2>": <answer2>,
      ...
  }}
  
  For boolean questions, use true/false.
  For number/integer questions, provide a numeric value within the specified range.
  For string questions, provide a text description.
  For array questions, provide a JSON array.
  
  Ensure all answers match their specified types and constraints.

evaluate_acceptance_criteria: |
  Evaluate this GENERATED image against acceptance criteria, comparing it to the ORIGINAL image.
  
  ORIGINAL IMAGE DESCRIPTION:
  {original_description}
  
  QUESTION ANSWERS (for context):
  {questions_summary}
  
  ACCEPTANCE CRITERIA:
  {criteria_text}
  
  For each criterion, determine if it passes (true/false or within min/max range).
  Then calculate overall score: (passed_criteria / total_criteria) * 100
  
  Provide your evaluation in JSON format:
  {{
      "overall_score": <0-100>,
      "criteria_results": {{
          "<field1>": <true/false or value>,
          "<field2>": <true/false or value>,
          ...
      }}
  }}

compare_images: |
  Compare these two images and analyze the differences.
  
  Focus on:
  1. Similarity score (0.0 = completely different, 1.0 = identical)
  2. What differences exist? (clothing, pose, features, background, proportions)
  3. Overall analysis
  
  Provide your comparison in JSON format:
  {{
      "similarity_score": <0.0-1.0>,
      "differences": ["difference1", "difference2", ...],
      "analysis": "detailed analysis text"
  }}

describe_image: |
  Describe this image in detail. Focus on:
  1. Main subject (person, object, scene)
  2. If person: appearance, pose, clothing
  3. Background/setting
  4. Overall composition and notable details
  
  Provide a detailed description.

describe_image_as_terms: |
  Analyze this image and extract Stable Diffusion prompt terms.
  
  Return a JSON object with three arrays:
  - positive_terms: Array of comma-separated prompt terms that should be in the positive prompt (e.g., ["summer dress", "natural lighting", "relaxed pose"])
  - negative_terms: Array of terms that should be in the negative prompt (e.g., ["blurry", "deformed", "low quality"])
  - must_include: Array of terms that MUST be included (e.g., ["same person", "identical facial features"])
  - ban_terms: Array of terms that MUST be banned (e.g., ["business suit", "formal attire"])
  
  Guidelines:
  - Each term should be a short phrase (1-3 words typically)
  - Terms should be comma-separated style (like ComfyUI prompts)
  - Focus on what's visible in the image
  - For must_include/ban_terms, only include if there are specific requirements
  
  Provide your response in JSON format:
  {{
    "positive_terms": ["term1", "term2", ...],
    "negative_terms": ["term1", "term2", ...],
    "must_include": ["term1", ...],
    "ban_terms": ["term1", ...]
  }}

improve_prompts: |
  You are helping improve image generation prompts for Stable Diffusion.
  
  Current positive prompt: {current_positive}
  Current negative prompt: {current_negative}
  
  Evaluation results:
  - Overall score: {overall_score}%
  - Failed criteria: {failed_criteria}
  
  Image comparison:
  - Similarity: {similarity_score}
  - Differences: {differences}
  - Analysis: {analysis}
  
  Rules to achieve:
  {rules_text}
  
  Important constraints:
  1. The rules are authoritative. Optimise the prompts to satisfy the failed criteria first.
  2. Use the tags provided in the rules:
     - Ensure all must_include terms appear in the positive prompt.
     - Ensure all ban_terms appear in the negative prompt.
     - Do NOT put must_include terms (or obvious variants/plurals) into the negative prompt.
     - Do NOT put ban_terms (or obvious variants/plurals) into the positive prompt.
  3. Preserve identity, pose, background, and body proportions when asked, by describing them explicitly in the positive prompt.
  4. Output prompts as short, comma-separated tags/phrases only. Do NOT output full sentences, and do NOT use negations like "no X" or "not X" (negations belong in the negative prompt as plain terms).

  Suggest improved positive and negative prompts that:
  1. Address the failed criteria
  2. Maintain what's working well
  3. Better achieve the rules
  4. Follow Stable Diffusion prompt best practices
  
  Provide your suggestions in JSON format:
  {{
      "positive": "<improved positive prompt>",
      "negative": "<improved negative prompt>"
  }}

generate_base_prompts: |
  You are generating a CLEAN starting positive and negative prompt for Stable Diffusion img2img/inpainting.
  
  Context:
  - ORIGINAL IMAGE DESCRIPTION (what we are starting from):
    {original_description}
  - SCOPE:
    {scope}
  
  ACTIVE CRITERIA (authoritative):
  {active_criteria_text}
  
  Rules:
  - The positive prompt MUST include all must_include terms from the active criteria (or obvious close variants).
  - The negative prompt MUST include all ban_terms from the active criteria (or obvious close variants).
  - Avoid putting must_include terms into the negative prompt.
  - Avoid putting ban_terms into the positive prompt.
  - If criteria ask to preserve identity/pose/background/body proportions, explicitly include those preserve tags in the positive prompt.
  - IMPORTANT: Prompt order matters in Stable Diffusion. Put the PRIMARY CHANGE (must_include terms from "change" intent criteria) at the FRONT of the positive prompt for maximum weight.
  - Then add scene/setting context, then preservation terms (identical features, same pose, etc.).
  - Output short comma-separated tags/phrases only. No full sentences. No "no X"/"not X" phrases.
  
  Output JSON ONLY:
  {{
      "positive": "<comma-separated tags>",
      "negative": "<comma-separated tags>"
  }}

suggest_rules_tags: |
  You are a YAML configuration reviewer. Your job is to improve the data-driven tags for each acceptance criterion in a rules.yaml file.
  
  Guidelines:
  {guidelines}
  
  Here is the current rules.yaml:
  ```yaml
  {rules_yaml}
  ```
  
  Focus ONLY on `acceptance_criteria` entries. Do NOT change:
  - project name or max_iterations
  - criteria field names
  - criteria questions
  - criteria type/min/max (unless they are clearly invalid; if so, put it in notes only)
  - the `questions:` section
  
  For each acceptance criterion, ensure these keys exist and are appropriate:
  - intent: "change" or "preserve"
  - edit_strength: "low" | "medium" | "high"
  - must_include: list of short prompt phrases that help satisfy the criterion
  - ban_terms: list of terms that must not appear in the generated result (or that should be strongly discouraged via negative prompt)
  - avoid_terms: list of terms to discourage (softer than ban_terms)
  
  Output JSON ONLY in the following structure:
  {{
    "acceptance_criteria": [
      {{
        "field": "<field>",
        "intent": "change|preserve",
        "edit_strength": "low|medium|high",
        "must_include": ["..."],
        "ban_terms": ["..."],
        "avoid_terms": ["..."],
        "notes": "short rationale / caveats"
      }}
    ],
    "general_notes": ["..."]
  }}

suggest_mask_terms: |
  You are helping improve mask-specific terms for Stable Diffusion inpainting.
  
  MASK CONTEXT:
  - Mask name: {mask_name}
  - Mask description: {mask_description}
  
  LATEST ITERATION DESCRIPTION (what was actually generated):
  {latest_iteration_description}
  
  CURRENT MASK TERMS:
  - must_include: {current_must_include}
  - ban_terms: {current_ban_terms}
  - avoid_terms: {current_avoid_terms}
  
  EVALUATION RESULTS:
  - Overall score: {overall_score}%
  - Failed criteria: {failed_criteria}
  
  ACTIVE CRITERIA FOR THIS MASK:
  {active_criteria_text}
  
  Guidelines:
  1. These terms apply ONLY to the masked area (inpainting region)
  2. must_include: Terms that MUST appear in the positive prompt for the masked area
  3. ban_terms: Terms that MUST appear in the negative prompt (things to avoid in masked area)
  4. avoid_terms: Terms to discourage (softer than ban_terms)
  5. Base suggestions on what's actually in the latest iteration image
  6. Focus on what should be in the masked area based on the criteria
  7. Keep terms short (1-3 words typically)
  8. Don't suggest terms that contradict the image description
  
  Suggest improved mask terms that:
  1. Address failed criteria specific to the masked area
  2. Match what should be in the masked region based on the criteria
  3. Are consistent with the latest iteration description
  4. Help achieve the goals for this specific mask
  
  Provide your suggestions in JSON format:
  {{
      "must_include": ["term1", "term2", ...],
      "ban_terms": ["term1", "term2", ...],
      "avoid_terms": ["term1", "term2", ...]
  }}

recommend_parameters: |
  Analyze this GENERATED image and recommend adjustments to the denoise and cfg (Classifier-Free Guidance) parameters for the next iteration.
  
  CONTEXT:
  - Current denoise: {current_denoise} (0.0 = no change, 1.0 = complete regeneration)
  - Current cfg: {current_cfg} (lower = more creative/flexible, higher = more prompt-adherent)
  - Original image description: {original_description}
  - Evaluation results: {evaluation_summary}
  - Failed criteria: {failed_criteria}
  - Image comparison: {comparison_summary}
  
  ANALYSIS TASKS:
  1. Look for visual artifacts (distortions, blur, over-saturation, deformities)
  2. Assess whether desired changes are being applied (or if the image is too similar to original)
  3. Check if the image quality is degrading (too much change) or if changes aren't happening (too little change)
  4. Consider whether the issue is likely due to:
     - Too low denoise/cfg: changes not being applied, image too similar to original
     - Too high denoise/cfg: artifacts, deformities, over-processing, loss of detail
  
  RECOMMENDATIONS:
  - For denoise: recommend "increase", "decrease", or "keep" based on whether changes need more/less strength
  - For cfg: recommend "increase", "decrease", or "keep" based on whether prompt adherence needs to be stronger/weaker
  - Provide confidence level (0.0-1.0) for each recommendation
  - Provide brief reasoning for each recommendation
  
  Provide your recommendations in JSON format:
  {{
    "denoise_recommendation": "increase|decrease|keep",
    "denoise_confidence": <0.0-1.0>,
    "denoise_reasoning": "brief explanation",
    "cfg_recommendation": "increase|decrease|keep",
    "cfg_confidence": <0.0-1.0>,
    "cfg_reasoning": "brief explanation",
    "overall_quality_assessment": "description of image quality and any artifacts"
  }}
