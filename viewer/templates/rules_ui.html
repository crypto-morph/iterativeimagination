<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules UI - {{ project_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex; gap:12px; align-items:baseline; justify-content:space-between;">
                <div>
                    <h1>Rules UI: {{ project_name }}</h1>
                    <p>Structured editor for <code>config/rules.yaml</code> (mask-aware acceptance criteria).</p>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <a class="btn" href="/project/{{ project_name }}/mask">Mask editor</a>
                    <a class="btn" href="/project/{{ project_name }}/live">Live run</a>
                    <a class="btn" href="/">Back</a>
                </div>
            </div>
        </header>

        <main>
            <section class="rulesui-toolbar">
                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                    <button id="btnReload" class="btn">Reload</button>
                    <button id="btnSave" class="btn primary" disabled>Save rules.yaml</button>
                    <button id="btnShowYaml" class="btn">YAML</button>
                    <span id="rulesuiStatus" class="muted"></span>
                </div>
                <div id="rulesuiLint" class="lint-box hidden"></div>
            </section>

            <section class="rulesui-layout" style="margin-top:14px;">
                <aside class="rulesui-left">
                    <details class="rulesui-details" open>
                        <summary>Scope</summary>
                        <div class="muted" style="margin-top:6px;">
                            Pick a <strong>Mask: name</strong> to edit which criteria are active for that mask.
                            Inactive criteria are shown grey at the bottom â€” click one to activate it for the current mask.
                            <strong>Show all</strong> is just a view filter.
                        </div>
                        <div id="scopeList" class="scope-list" style="margin-top:10px;"></div>
                        <div class="rulesui-scope-actions" style="margin-top:10px;">
                            <a id="btnEditMask" class="btn" href="/project/{{ project_name }}/mask?mask=default">Edit selected mask</a>
                            <label class="muted">New mask:
                                <input id="newMaskNameRulesUI" type="text" placeholder="left / middle / right" style="width:160px;">
                            </label>
                            <button id="btnCreateMaskRulesUI" class="btn">Create & draw</button>
                        </div>
                        <div class="muted" style="margin-top:8px;">
                            Tip: <strong>default</strong> saves to <code>input/mask.png</code>. Named masks save to <code>input/masks/&lt;name&gt;.png</code>.
                        </div>
                    </details>

                    <details class="rulesui-details" open style="margin-top:12px;">
                        <summary>Scope preview</summary>
                        <div class="muted" style="margin-top:6px;">Shows the currently selected mask overlay.</div>
                        <div class="mask-preview" style="margin-top:10px;">
                            <div class="mask-canvas-wrap">
                                <img id="scopeBaseImg" class="mask-base" src="/api/project/{{ project_name }}/input/image" alt="Input">
                                <img id="scopeMaskImg" class="mask-canvas" src="" alt="Mask overlay">
                            </div>
                        </div>
                    </details>

                    <details class="rulesui-details" style="margin-top:12px;">
                        <summary>Project settings (global)</summary>
                        <div class="muted" style="margin-top:6px;">These apply to the whole run (all masks).</div>
                        <div class="form-grid">
                            <label class="muted">Max iterations
                                <input id="projMaxIterations" type="number" min="1" max="50" value="20">
                            </label>
                            <label class="muted">Preserve heavy
                                <select id="projPreserveHeavy">
                                    <option value="auto">auto</option>
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                            </label>
                            <label class="muted">Lock seed
                                <select id="projLockSeed">
                                    <option value="true">true</option>
                                    <option value="false">false</option>
                                </select>
                            </label>
                        </div>
                    </details>
                </aside>

                <section class="rulesui-main">
                    <div class="rulesui-actions">
                        <button id="btnAddCriterion" class="btn">Add criterion</button>
                        <button id="btnAddQuestion" class="btn">Add question</button>
                        <span class="muted">New items start in the current scope.</span>
                    </div>
                    <div class="board">
                        <div class="board-col" data-intent="change">
                            <div class="board-col-header">
                                <h3>Change goals</h3>
                                <div class="muted">Drag criteria here</div>
                            </div>
                            <div id="colChange" class="board-col-body dropzone"></div>
                        </div>
                        <div class="board-col" data-intent="preserve">
                            <div class="board-col-header">
                                <h3>Preserve goals</h3>
                                <div class="muted">Drag criteria here</div>
                            </div>
                            <div id="colPreserve" class="board-col-body dropzone"></div>
                        </div>
                    </div>

                    <details class="rulesui-details" style="margin-top:14px;">
                        <summary>Questions</summary>
                        <div id="questionsList" class="questions-list muted" style="margin-top:8px;"></div>
                    </details>
                </section>

                <aside class="rulesui-right">
                    <h3>Criterion details</h3>
                    <div id="criterionEmpty" class="muted" style="margin-top:8px;">Click a criterion card to edit it.</div>
                    <div id="criterionEditor" class="hidden">
                        <div class="muted">Field</div>
                        <div id="critField" class="mono" style="margin:6px 0 10px 0;"></div>
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:8px;">
                            <button id="btnDeactivateCurrent" class="btn">Deactivate for current mask</button>
                            <button id="btnDeleteCriterion" class="btn">Delete criterion</button>
                        </div>

                        <details class="rulesui-details" open>
                            <summary>Basics</summary>
                            <label class="muted" style="margin-top:8px;">Question
                                <textarea id="critQuestion" class="code-textarea" style="min-height:80px;"></textarea>
                            </label>
                            <div class="form-grid" style="margin-top:10px;">
                                <label class="muted">Intent
                                    <select id="critIntent">
                                        <option value="change">change</option>
                                        <option value="preserve">preserve</option>
                                    </select>
                                </label>
                                <label class="muted">Edit strength
                                    <select id="critStrength">
                                        <option value="low">low</option>
                                        <option value="medium">medium</option>
                                        <option value="high">high</option>
                                    </select>
                                </label>
                            </div>
                        </details>

                        <details class="rulesui-details" style="margin-top:10px;">
                            <summary>Mask membership</summary>
                            <div class="muted" style="margin-top:6px;">Which masks should evaluate/use this criterion.</div>
                            <div id="critScopes" class="scope-chips" style="margin-top:8px;"></div>
                        </details>

                        <details class="rulesui-details" open style="margin-top:10px;">
                            <summary>Prompt guidance (advanced)</summary>
                            <label class="muted" style="margin-top:8px;">must_include (one per line)
                                <textarea id="critMust" class="code-textarea" style="min-height:90px;"></textarea>
                            </label>
                            <label class="muted" style="margin-top:10px;">ban_terms (one per line)
                                <textarea id="critBan" class="code-textarea" style="min-height:90px;"></textarea>
                            </label>
                            <label class="muted" style="margin-top:10px;">avoid_terms (one per line)
                                <textarea id="critAvoid" class="code-textarea" style="min-height:90px;"></textarea>
                            </label>
                        </details>
                    </div>

                    <details class="rulesui-details" style="margin-top:12px;">
                        <summary>YAML preview</summary>
                        <div class="muted" style="margin-top:6px;">Use the YAML button above for the full preview + copy.</div>
                        <textarea id="yamlPreview" class="code-textarea" readonly style="min-height:140px;"></textarea>
                    </details>
                </aside>
            </section>
        </main>
    </div>

    <div id="yamlModal" class="modal hidden" aria-hidden="true">
        <div class="modal-backdrop" id="yamlBackdrop"></div>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="yamlTitle">
            <div class="modal-header">
                <div>
                    <h3 id="yamlTitle" style="margin:0;">rules.yaml (preview)</h3>
                    <div class="muted">Read-only. Use Save to write to disk.</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button id="btnCopyYaml" class="btn">Copy</button>
                    <button id="btnCloseYaml" class="btn primary">Close</button>
                </div>
            </div>
            <textarea id="yamlModalText" class="code-textarea" readonly style="min-height:520px;"></textarea>
        </div>
    </div>

    <script>
        window.__RULESUI_PROJECT__ = "{{ project_name }}";
    </script>
    <script src="{{ url_for('static', filename='js/rules_ui.js') }}"></script>
</body>
</html>

